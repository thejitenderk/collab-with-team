name: Terraform Infrastructure Deployment

on:
  workflow_dispatch:

  # pull_request:
  #   branches:
  #     - main
  #     - features/*
  push:
    branches:
      - main
      - features/*

permissions:
  contents: read
  id-token: write

jobs:
  # terraformLintAndScan:
  #   name: "Terraform Linting and Security Scans"
  #   runs-on: ubuntu-latest
  #   environment: dev  # Change to your actual environment (dev, staging, prod)
  #   steps:
  #     # Checkout the repository to the GitHub Actions runner
  #     - name: Checkout Repository Code
  #       uses: actions/checkout@v6.0.2

  #     # Authenticate with Azure using the service principal credentials
  #     - name: Azure Authentication
  #       uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id: ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  #     # Install and configure Terraform CLI
  #     - name: Setup Terraform CLI
  #       uses: hashicorp/setup-terraform@v1

  #     # Ensure the correct version of Terraform is installed
  #     - name: Verify Terraform Version
  #       run: terraform --version

  #     # Lint Terraform code to ensure formatting and validity
  #     - name: Lint Terraform Configuration
  #       run: |
  #         terraform fmt -check -diff  # Check for any formatting issues
  #         terraform validate  # Validate the Terraform configuration files

  #     # Run security scan on Terraform configuration using tfsec
  #     - name: Run tfsec Security Scan
  #       run: |
  #         curl -sSL https://github.com/aquasecurity/tfsec/releases/download/v1.0.0/tfsec-linux-amd64 -o /usr/local/bin/tfsec
  #         chmod +x /usr/local/bin/tfsec
  #         tfsec ./environment/dev # Perform security scan on the dev environment

  terraformPlanAndCostEstimation:
    # needs: terraformLintAndScan
    name: "Terraform Plan and Cost Estimation"
    runs-on: ubuntu-latest
    environment: dev  # Change to your actual environment (dev, staging, prod)
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout Repository Code
        uses: actions/checkout@v6.0.2

      # Authenticate with Azure using the service principal credentials
      - name: Azure Authentication
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Install and configure Terraform CLI
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v1

      # Ensure the correct version of Terraform is installed
      - name: Verify Terraform Version
        run: terraform --version

      # Initialize Terraform configuration for the dev environment
      - name: Terraform Initialization
        run: terraform -chdir=environment/dev init

      # Plan the Terraform infrastructure changes
      - name: Terraform Plan Execution
        run: |
          BUILD_ID=$(date +%Y%m%d%H%M%S)  # Generate a unique build ID based on the timestamp
          terraform -chdir=environment/dev plan -out=./plan_${BUILD_ID}.tfplan
        continue-on-error: false  # Fail immediately if plan execution fails

      # Perform cost estimation based on the Terraform plan

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        # See https://github.com/infracost/actions/tree/master/setup for other inputs
        # If you can't use this action, use Docker image infracost/infracost:ci-0.10
        with:
          api-key: ico-gtkv3hjTodX5SSd1iXocWqlbPY1VSvJC
          path: ./environment/dev

      # Upload the Infracost JSON file as an artifact
      - name: Upload Infracost cost estimate file
        uses: actions/upload-artifact@v6.0.0
        with:
          name: infracost-estimate
          path: ./infracost-base.json

      # Upload Terraform plan as an artifact for the apply job
      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: terraform-plan
          path: ./plan_${BUILD_ID}.tfplan

  terraformApplyAndApproval:
    needs: terraformPlanAndCostEstimation
    name: "Terraform Apply with Manual Approval"
    runs-on: ubuntu-latest
    environment: dev  # Change to your actual environment (dev, staging, prod)
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout Repository Code
        uses: actions/checkout@v6.0.2

      # Authenticate with Azure using the service principal credentials
      - name: Azure Authentication
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Install and configure Terraform CLI
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v1

      # Ensure the correct version of Terraform is installed
      - name: Verify Terraform Version
        run: terraform --version

      # Initialize Terraform configuration for the dev environment
      - name: Terraform Initialization
        run: terraform -chdir=environment/dev init

      # Download the previously uploaded Terraform plan
      - name: Download Terraform Plan Artifact
        uses: actions/download-artifact@v7.0.0
        with:
          name: terraform-plan
          path: ./ # Path to download the artifact

      # Await manual approval for Terraform Apply
      - name: Await Manual Approval for Apply
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: terraform-apply-approval.yml  # Custom approval workflow file
          ref: refs/heads/main
        continue-on-error: true  # Allow workflow to wait for approval if not granted yet

      # Apply the Terraform plan after approval
      - name: Terraform Apply (Post-Approval)
        if: success()  # Only run if the manual approval step was successful
        run: terraform -chdir=environment/dev apply -auto-approve ./plan_${{ steps.download.outputs.build_id }}.tfplan
