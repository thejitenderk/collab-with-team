name: Terraform Infrastructure Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main   
  pull_request:
    branches:
      - main
      - dev

permissions:
  contents: read
  id-token: write

jobs:
  terraformLintAndScan:
    name: "Terraform Linting and Security Scans"
    runs-on: ubuntu-latest

    # environment: dev  # Change to your actual environment (dev, staging, prod)
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout Repository Code
        uses: actions/checkout@v6.0.2

      # Authenticate with Azure using the service principal credentials
      # - name: Azure Authentication
      #   uses: azure/login@v2
      #   with:
      #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Install and configure Terraform CLI
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v1

      # Ensure the correct version of Terraform is installed
      - name: Verify Terraform Version
        run: terraform --version

      # Lint Terraform code to ensure formatting and validity
      - name: Lint Terraform Configuration
        run: |
          terraform fmt -check -diff  # Check for any formatting issues
          terraform validate  # Validate the Terraform configuration files

      # Run security scan on Terraform configuration using tfsec
      - name: Run tfsec Security Scan
        run: |
          curl -sSL https://github.com/aquasecurity/tfsec/releases/download/v1.0.0/tfsec-linux-amd64 -o /usr/local/bin/tfsec
          chmod +x /usr/local/bin/tfsec
          tfsec ./environment/dev # Perform security scan on the dev environment

  terraformPlanAndCostEstimation:
    needs: terraformLintAndScan
    name: "Terraform Plan and Cost Estimation"
    runs-on: ubuntu-latest
    outputs:
      plan_file: ${{ steps.save_plan.outputs.plan_file }}
      
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout Repository Code
        uses: actions/checkout@v6.0.2

      # Authenticate with Azure using the service principal credentials
      - name: Azure Authentication
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Install and configure Terraform CLI
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v1

      # Ensure the correct version of Terraform is installed
      - name: Verify Terraform Version
        run: terraform --version

      # Initialize Terraform configuration for the dev environment
      - name: Terraform Initialization
        run: terraform -chdir=environment/dev init

      # Plan the Terraform infrastructure changes
      - name: Terraform Plan Execution
        run: |
          terraform -chdir=environment/dev plan -out=./plan_$GITHUB_RUN_ID.tfplan
          echo "plan_file=plan_$GITHUB_RUN_ID.tfplan" >> $GITHUB_OUTPUT
        id: save_plan
        continue-on-error: false  # Fail immediately if plan execution fails

      # Plan the Terraform infrastructure changes
      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: terraform-plan
          path: ./environment/dev/plan_${{ GITHUB.RUN_ID }}.tfplan

  terraformApplyAndApproval:
    needs: terraformPlanAndCostEstimation
    name: "Terraform Apply with Manual Approval"
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: dev  # Change to your actual environment (dev, staging, prod)
    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout Repository Code
        uses: actions/checkout@v6.0.2

      # Authenticate with Azure using the service principal credentials
      - name: Azure Authentication
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Install and configure Terraform CLI
      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v1

      # Ensure the correct version of Terraform is installed
      - name: Verify Terraform Version
        run: terraform --version

      # Initialize Terraform configuration for the dev environment
      - name: Terraform Initialization
        run: terraform -chdir=environment/dev init

      # Download the previously uploaded Terraform plan
      - name: Download Terraform Plan Artifact
        uses: actions/download-artifact@v7.0.0
        with:
          name: terraform-plan
          path: ./environment/dev
          

      # Apply the Terraform plan after approval
      - name: Terraform Apply 
        if: success()  # Only run if the manual approval step was successful
        run: terraform -chdir=environment/dev apply -auto-approve ./${{ needs.terraformPlanAndCostEstimation.outputs.plan_file }}
